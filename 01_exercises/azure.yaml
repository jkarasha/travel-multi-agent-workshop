name: TravelAssistant
metadata:
  template: azd-init@1.5.1
hooks:
  preprovision:
    posix:
      shell: sh
      interactive: false
      continueOnError: false
      run: |
        # Check if OWNER_EMAIL is already set in azd environment
        EXISTING_OWNER=$(azd env get-value OWNER_EMAIL 2>/dev/null || echo "")
        if [ -z "$EXISTING_OWNER" ]; then
          CURRENT_USER=$(az account show --query user.name -o tsv 2>/dev/null || echo "user@example.com")
          echo "Auto-setting OWNER_EMAIL to: $CURRENT_USER"
          azd env set OWNER_EMAIL "$CURRENT_USER"
        else
          echo "OWNER_EMAIL already set to: $EXISTING_OWNER"
        fi
    windows:
      shell: pwsh
      interactive: false
      continueOnError: false
      run: |
        # Set OWNER_EMAIL from current Azure user
        try {
          $currentUser = az account show --query user.name -o tsv
          if ($currentUser -and $currentUser.Trim() -ne "") {
            Write-Host "Setting OWNER_EMAIL to: $($currentUser.Trim())"
            azd env set OWNER_EMAIL $currentUser.Trim()
          } else {
            Write-Host "Could not get current user, setting default"
            azd env set OWNER_EMAIL "user@example.com"
          }
        } catch {
          Write-Host "Could not get current user, setting default"
          azd env set OWNER_EMAIL "user@example.com"
        }
  postprovision:
    posix:
      shell: sh
      interactive: true
      continueOnError: false
      run: |
        echo "
        COSMOSDB_ENDPOINT=\"$COSMOSDB_ENDPOINT\"
        COSMOS_DB_DATABASE_NAME=\"TravelAssistant\"
        AZURE_OPENAI_ENDPOINT=\"$AZURE_OPENAI_ENDPOINT\"
        AZURE_OPENAI_EMBEDDING_DEPLOYMENT=\"$AZURE_OPENAI_EMBEDDINGDEPLOYMENTID\"
        AZURE_OPENAI_DEPLOYMENT=\"$AZURE_OPENAI_COMPLETIONSDEPLOYMENTID\"
        AZURE_OPENAI_API_VERSION=\"2024-12-01-preview\"
        MCP_AUTH_SECRET_KEY=\"travel-mcp-server-jwt-secret-for-local-development\"
        MCP_AUTH_TOKEN=\"travel-server-dev-token-2024\"
        MCP_SERVER_BASE_URL=\"http://localhost:8080\"
        " > ./python/.env

        echo "âœ… Environment file created at ./python/.env"

        # Create environment file for MCP server
        echo "
        COSMOSDB_ENDPOINT=\"$COSMOSDB_ENDPOINT\"
        COSMOS_DB_DATABASE_NAME=\"TravelAssistant\"
        AZURE_OPENAI_ENDPOINT=\"$AZURE_OPENAI_ENDPOINT\"
        AZURE_OPENAI_EMBEDDING_DEPLOYMENT=\"$AZURE_OPENAI_EMBEDDINGDEPLOYMENTID\"
        AZURE_OPENAI_DEPLOYMENT=\"$AZURE_OPENAI_COMPLETIONSDEPLOYMENTID\"
        AZURE_OPENAI_API_VERSION=\"2024-12-01-preview\"
        MCP_AUTH_SECRET_KEY=\"travel-mcp-server-jwt-secret-for-local-development\"
        MCP_AUTH_TOKEN=\"travel-server-dev-token-2024\"
        MCP_SERVER_BASE_URL=\"http://localhost:8080\"
        " > ./mcp_server/.env

        echo "âœ… Environment file created at ./mcp_server/.env"

        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“¦ Setting up Python virtual environment..."
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""

        # Check if virtual environment exists, create if not
        if [ ! -d "venv" ]; then
            echo "Creating Python virtual environment..."
            python3 -m venv venv
        fi

        # Activate virtual environment
        echo "Activating virtual environment..."
        . venv/bin/activate

        # Install requirements
        echo "Installing Python dependencies from requirements.txt..."
        if [ -f "requirements.txt" ]; then
            python -m pip install --upgrade pip setuptools wheel
            python -m pip install --prefer-binary -r requirements.txt
        else
            echo "âš ï¸  requirements.txt not found, installing basic dependencies..."
            python -m pip install --upgrade pip setuptools wheel
            python -m pip install azure-cosmos azure-identity openai python-dotenv
        fi

        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ï¿½ Loading data into Cosmos DB..."
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""

        cd python
        # Load data into Cosmos DB (from python directory)
        python data/seed_data.py
        cd ..

        echo ""
        echo "âœ… Setup complete!"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    windows:
      shell: pwsh
      interactive: true
      continueOnError: false
      run: |

        echo "
        COSMOSDB_ENDPOINT=""$env:COSMOSDB_ENDPOINT""
        COSMOS_KEY=""$env:COSMOS_KEY""
        COSMOS_DB_DATABASE_NAME=""TravelAssistant""
        AZURE_OPENAI_ENDPOINT=""$env:AZURE_OPENAI_ENDPOINT""
        AZURE_OPENAI_EMBEDDING_DEPLOYMENT=""$env:AZURE_OPENAI_EMBEDDINGDEPLOYMENTID""
        AZURE_OPENAI_DEPLOYMENT=""$env:AZURE_OPENAI_COMPLETIONSDEPLOYMENTID""
        AZURE_OPENAI_API_VERSION=""2024-12-01-preview""
        MCP_AUTH_SECRET_KEY=""travel-mcp-server-jwt-secret-for-local-development""
        MCP_AUTH_TOKEN=""travel-server-dev-token-2024""
        MCP_SERVER_BASE_URL=""http://localhost:8080""
        " > ./python/.env

        Write-Host "âœ… Environment file created at ./python/.env"

        # Create environment file for MCP server
        echo "
        COSMOSDB_ENDPOINT=""$env:COSMOSDB_ENDPOINT""
        COSMOS_KEY=""$env:COSMOS_KEY""
        COSMOS_DB_DATABASE_NAME=""TravelAssistant""
        AZURE_OPENAI_ENDPOINT=""$env:AZURE_OPENAI_ENDPOINT""
        AZURE_OPENAI_EMBEDDING_DEPLOYMENT=""$env:AZURE_OPENAI_EMBEDDINGDEPLOYMENTID""
        AZURE_OPENAI_DEPLOYMENT=""$env:AZURE_OPENAI_COMPLETIONSDEPLOYMENTID""
        AZURE_OPENAI_API_VERSION=""2024-12-01-preview""
        MCP_AUTH_SECRET_KEY=""travel-mcp-server-jwt-secret-for-local-development""
        MCP_AUTH_TOKEN=""travel-server-dev-token-2024""
        MCP_SERVER_BASE_URL=""http://localhost:8080""
        " > ./mcp_server/.env

        Write-Host "âœ… Environment file created at ./mcp_server/.env"
        Write-Host ""
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        Write-Host "ğŸ“¦ Setting up Python virtual environment..."
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        Write-Host ""

        # Check if virtual environment exists, create if not
        if (-not (Test-Path "venv")) {
            Write-Host "Creating Python virtual environment..."
            python -m venv venv
        }

        # Activate virtual environment
        Write-Host "Activating virtual environment..."
        & ".\venv\Scripts\Activate.ps1"

        # Install requirements
        Write-Host "Installing Python dependencies from requirements.txt..."
        if (Test-Path "requirements.txt") {
            python -m pip install --upgrade pip setuptools wheel
            python -m pip install --prefer-binary -r requirements.txt
        } else {
            Write-Host "âš ï¸  requirements.txt not found, installing basic dependencies..."
            python -m pip install --upgrade pip setuptools wheel
            python -m pip install azure-cosmos azure-identity openai python-dotenv
        }

        Write-Host ""
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        Write-Host "ï¿½ Loading data into Cosmos DB..."
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        Write-Host ""

        # Data seeding with error handling
        if (-not (Test-Path "python")) {
            Write-Host "âš ï¸  WARNING: python directory not found!" -ForegroundColor Yellow
            Write-Host "Skipping data seed - you'll need to run it manually later" -ForegroundColor Yellow
        } elseif (-not (Test-Path "python\data\seed_data.py")) {
            Write-Host "âš ï¸  WARNING: seed_data.py not found!" -ForegroundColor Yellow
            Write-Host "Skipping data seed - you'll need to run it manually later" -ForegroundColor Yellow
        } else {
            try {
                Push-Location python
                Write-Host "Running seed_data.py..." -ForegroundColor Cyan
                
                # Capture output and errors
                $output = python data\seed_data.py 2>&1
                $exitCode = $LASTEXITCODE
                
                # Display output
                $output | ForEach-Object { Write-Host $_ }
                
                if ($exitCode -eq 0) {
                    Write-Host "âœ… Data seeded successfully!" -ForegroundColor Green
                } else {
                    Write-Host "âš ï¸  WARNING: seed_data.py returned exit code $exitCode" -ForegroundColor Yellow
                    Write-Host "This might mean data already exists (which is OK) or there was an error." -ForegroundColor Yellow
                    Write-Host "Check the output above for details." -ForegroundColor Yellow
                }
            } catch {
                Write-Host "âš ï¸  WARNING: Failed to run seed_data.py" -ForegroundColor Yellow
                Write-Host "Error: $($_.Exception.Message)" -ForegroundColor Yellow
                Write-Host "You may need to run it manually later." -ForegroundColor Yellow
            } finally {
                Pop-Location
            }
        }

        Write-Host ""
        Write-Host "âœ… Setup complete!"
        Write-Host ""
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
